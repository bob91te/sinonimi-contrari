<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="color-scheme" content="light">
  <title>Sinonimi & Contrari — v6 Minimal</title>
  <meta name="theme-color" content="#f9fafb">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icons/icon-192.png">
  <style>
    :root{
      --bg:#f9fafb; --card:#ffffff; --line:#e5e7eb;
      --text:#1a1c22; --muted:#6b7280;
      --primary:#3b82f6; --ok:#10b981; --err:#ef4444;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:980px; margin:24px auto; padding:0 16px}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
    .brand{display:flex; align-items:center; gap:12px}
    .brand img{height:32px}
    h1{font-size:20px; margin:0}
    .sub{color:var(--muted); font-size:12px; margin-top:2px}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      background:#fff; border:1px solid var(--line); border-radius:12px; padding:8px 12px; cursor:pointer;
    }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; font-weight:700 }
    .btn.ghost{ background:#fff; }
    .btn:active{ transform:translateY(1px) }
    select,input[type=text]{
      background:#fff; border:1px solid var(--line); border-radius:12px; padding:8px 12px; color:var(--text);
    }
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:960px){ .grid{ grid-template-columns:1.2fr .8fr } }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:16px;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .word{font-size:42px; font-weight:800; letter-spacing:.2px; margin:8px 0}
    .opts{display:grid; grid-template-columns:1fr; gap:8px}
    @media(min-width:640px){ .opts{ grid-template-columns:1fr 1fr } }
    .opt{
      background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; text-align:center; cursor:pointer;
      transition:border-color .15s ease;
    }
    .opt:hover{ border-color:#cbd5e1 }
    .opt.ok{ border-color: var(--ok) }
    .opt.err{ border-color: var(--err) }
    .stat{background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px 12px}
    .stat .k{font-size:12px; color:var(--muted)} .stat .v{font-size:18px; font-weight:800}
    .progress{height:8px; background:#fff; border:1px solid var(--line); border-radius:999px; overflow:hidden}
    .progress>div{height:100%; background: var(--primary); width:0; transition: width .2s ease}
    .msg{min-height:22px; color:var(--muted); margin-top:6px}
    .msg.ok{ color: var(--ok) } .msg.err{ color: var(--err) }
    .list{max-height:240px; overflow:auto; border:1px solid var(--line); border-radius:12px; padding:10px; background:#fff}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:12px; padding:2px 6px; border:1px solid var(--line); border-radius:6px; background:#fff}
    .hint{font-size:12px; color:var(--muted)}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .pill{display:inline-block; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted)}
    :focus-visible{ outline: 2px solid var(--primary); outline-offset: 2px }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="./logo.svg" alt="S&C logo">
        <div>
          <h1>Sinonimi & Contrari</h1>
          <div class="sub">v6 — minimal, educativo</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="dailyBtn" class="btn ghost">Sfida giornaliera</button>
        <button id="shareBtn" class="btn ghost" disabled>Condividi</button>
        <button id="helpBtn" class="btn ghost">Aiuto</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div><label>Pack</label>
            <select id="packSel"><option value="it_core" selected>Italiano</option><option value="en_core">English</option></select>
          </div>
          <div><label>Modalità</label>
            <select id="mode"><option value="syn">Sinonimi</option><option value="ant">Contrari</option><option value="mix" selected>Misto</option></select>
          </div>
          <div><label>Difficoltà</label>
            <select id="difficulty"><option value="easy" selected>Facile</option><option value="medium">Media</option><option value="hard">Difficile</option></select>
          </div>
          <div><label>Timer</label>
            <select id="timer"><option value="60" selected>60s</option><option value="90">90s</option><option value="120">120s</option></select>
          </div>
          <label><input type="checkbox" id="typoOK" checked> Tolleranza (±1)</label>
          <label><input type="checkbox" id="pluralOK" checked> Plurali</label>
          <label><input type="checkbox" id="soundOK" checked> Suoni</label>
          <button id="startBtn" class="btn primary">Avvia</button>
          <button id="resetBtn" class="btn">Reset</button>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="stat"><div class="k">Tempo</div><div class="v" id="time">—</div></div>
          <div class="stat"><div class="k">Punti</div><div class="v" id="score">0</div></div>
          <div class="stat"><div class="k">Combo</div><div class="v" id="combo">x1</div></div>
          <div class="stat"><div class="k">Migliore</div><div class="v" id="best">0</div></div>
        </div>
        <div class="progress" style="margin-top:8px"><div id="timeBar"></div></div>

        <div id="questionArea" style="margin-top:12px">
          <div class="pill" id="modeTag">Misto</div>
          <div class="word" id="prompt">—</div>
          <div class="opts" id="options" style="display:none"></div>
          <div id="freeArea" class="row" style="display:none">
            <input id="freeInput" type="text" placeholder="Scrivi la risposta" style="flex:1">
            <button id="freeOK" class="btn primary">OK</button>
          </div>
          <div class="msg" id="msg"></div>
          <div class="hint">Suggerimento: in modalità Difficile premi <span class="kbd">Invio</span> per confermare.</div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0">Storico</h3>
        <div class="divider"></div>
        <div class="list"><ol id="history"></ol></div>
      </div>
    </div>
  </div>

<script>
  // Utility
  const $ = s=>document.querySelector(s);
  const rand = a=> a[Math.floor(Math.random()*a.length)];
  const stripAccents = s => s.normalize('NFD').replace(/\p{Diacritic}+/gu,'');
  const normalize = s => stripAccents((s||'').trim().toLowerCase());
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function lev(a,b){ const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const cost = a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost); } } return dp[m][n]; }

  // Audio (simple)
  let audioCtx=null;
  function beep(freq=880, ms=90, type='sine'){
    if(!$('#soundOK').checked) return;
    if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ return; } }
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.22, audioCtx.currentTime+0.01);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+ms/1000);
    o.start(); o.stop(audioCtx.currentTime+ms/1000+0.02);
  }

  // State
  let DATA={}, STATE={started:false,mode:'mix',diff:'easy',secs:60,timer:null,timeLeft:0,score:0,combo:1,best:0,current:null,correct:null,qcount:0,ok:0,ko:0,pack:'it_core',last:[]};
  const el={packSel:$('#packSel'),mode:$('#mode'),difficulty:$('#difficulty'),timerSel:$('#timer'),
    typoOK:$('#typoOK'),pluralOK:$('#pluralOK'),start:$('#startBtn'),reset:$('#resetBtn'),share:$('#shareBtn'),
    time:$('#time'),timeBar:$('#timeBar'),score:$('#score'),combo:$('#combo'),best:$('#best'),
    prompt:$('#prompt'),options:$('#options'),msg:$('#msg'),history:$('#history'),freeArea:$('#freeArea'),freeInput:$('#freeInput')};
  try{ STATE.best=Number(localStorage.getItem('sc_best')||'0')||0; }catch(e){}
  el.best.textContent=String(STATE.best);

  function setMsg(t,k=''){ el.msg.className='msg '+(k||''); el.msg.textContent=t; }
  function tick(){ STATE.timeLeft--; updateTime(); if(STATE.timeLeft<=0){ end(); } }
  function updateTime(){ el.time.textContent=STATE.timeLeft+'s'; el.timeBar.style.width=Math.max(0,Math.min(100,(STATE.timeLeft/STATE.secs)*100))+'%'; }
  function addHistory(t){ const li=document.createElement('li'); li.textContent=t; el.history.appendChild(li); el.history.parentElement.scrollTop=el.history.parentElement.scrollHeight; }

  function wordPool(){ return Object.keys(DATA); }
  function pick(mode){
    const w=rand(wordPool()); const syn=DATA[w].syn||[], ant=DATA[w].ant||[];
    let m = mode==='mix' ? (Math.random()<0.5?'syn':'ant') : mode;
    const arr=(m==='syn'?syn:ant);
    const correct = arr.length? rand(arr) : '—';
    return {word:w,m,correct,syn,ant};
  }
  function buildChoices(correct, syn, ant){
    const choices=[correct];
    const distract=[...syn,...ant,...wordPool()].filter(x=>x && normalize(x)!==normalize(correct));
    shuffle(distract);
    const want=(STATE.diff==='easy')?4:6;
    for(const d of distract){ if(choices.length>=want) break; if(!choices.includes(d)) choices.push(d); }
    return shuffle(choices.slice(0,want));
  }

  function start(){
    STATE.pack=el.packSel.value; STATE.mode=el.mode.value; STATE.diff=el.difficulty.value; STATE.secs=Number(el.timerSel.value)||60;
    STATE.timeLeft=STATE.secs; STATE.score=0; STATE.combo=1; STATE.qcount=0; STATE.ok=0; STATE.ko=0; STATE.started=true; STATE.last=[];
    el.options.style.display=(STATE.diff==='hard')?'none':'grid'; el.freeArea.style.display=(STATE.diff==='hard')?'flex':'none';
    el.history.innerHTML=''; setMsg(''); nextQuestion(); clearInterval(STATE.timer); STATE.timer=setInterval(tick,1000);
    updateTime(); el.score.textContent='0'; el.combo.textContent='x1'; $('#modeTag').textContent=(STATE.mode==='syn'?'Sinonimi':STATE.mode==='ant'?'Contrari':'Misto');
    el.share.disabled=true; if(STATE.diff==='hard'){ el.freeInput.value=''; el.freeInput.focus(); }
  }

  function end(){
    STATE.started=false; clearInterval(STATE.timer);
    setMsg('⏱️ Tempo scaduto. Punteggio: '+STATE.score,'');
    if(STATE.score>STATE.best){ STATE.best=STATE.score; try{localStorage.setItem('sc_best', String(STATE.best));}catch(e){}; el.best.textContent=String(STATE.best); setMsg('🏆 Nuovo record!','ok'); }
    el.share.disabled=false;
  }

  function scoreDelta(){
    const base=100; let mult=STATE.combo;
    if(STATE.timeLeft/STATE.secs>0.66) mult+=0.5;
    return Math.round(base*mult);
  }
  function okFeedback(){ setMsg('Corretto!','ok'); beep(920,80,'triangle'); STATE.combo=Math.min(STATE.combo+1,5); el.combo.textContent='x'+STATE.combo; STATE.score+=scoreDelta(); el.score.textContent=String(STATE.score); STATE.ok++; STATE.last.push('🟩'); }
  function koFeedback(){ setMsg('Sbagliato.','err'); beep(240,100,'sawtooth'); STATE.combo=1; el.combo.textContent='x1'; STATE.timeLeft=Math.max(0,STATE.timeLeft-3); updateTime(); STATE.ko++; STATE.last.push('🟥'); }

  function matchesAnswer(ans, targets){
    if(targets.has(ans)) return true;
    if($('#pluralOK').checked){
      for(const t of targets){
        const vars = new Set([t, t.replace(/o$/,'i'), t.replace(/a$/,'e'), t.replace(/e$/,'i')]);
        if(vars.has(ans)) return true;
      }
    }
    if($('#typoOK').checked){
      for(const t of targets){ if(lev(ans,t)<=1) return true; }
    }
    return false;
  }

  function check(value, btn=null){
    if(!STATE.started) return;
    const ans=normalize(value); const {m,syn,ant}=STATE.current;
    const valid=(m==='syn'?syn:ant).map(x=>normalize(x));
    const ok=matchesAnswer(ans,new Set(valid));
    if(btn){ btn.classList.add(ok?'ok':'err'); }
    addHistory((m==='syn'?'SIN':'ANT')+': '+STATE.current.word+' → '+value+(ok?' ✓':' ✗ (corretto: '+STATE.correct+')'));
    if(ok) okFeedback(); else koFeedback();
    setTimeout(nextQuestion, 320);
  }

  function nextQuestion(){
    const q=pick(STATE.mode); STATE.current=q; STATE.correct=q.correct; STATE.qcount++;
    el.prompt.textContent=(q.m==='syn'?'Sinonimo di':'Contrario di')+' “'+q.word+'”';
    if(STATE.diff==='hard'){
      setMsg('Scrivi una risposta valida.');
    } else {
      const choices=buildChoices(q.correct,q.syn,q.ant);
      el.options.innerHTML='';
      choices.forEach(c=>{ const b=document.createElement('button'); b.className='opt'; b.textContent=c; b.addEventListener('click',()=>check(c,b)); el.options.appendChild(b); });
    }
  }

  // Bindings
  $('#startBtn').addEventListener('click', start);
  $('#resetBtn').addEventListener('click', ()=>{ STATE.started=false; clearInterval(STATE.timer); setMsg('Reset.'); el.prompt.textContent='—'; el.options.innerHTML=''; el.history.innerHTML=''; el.score.textContent='0'; el.combo.textContent='x1'; el.time.textContent='—'; el.timeBar.style.width='0%'; });
  $('#dailyBtn').addEventListener('click', ()=>{ const iso=(new Date()).toISOString().slice(0,10); STATE.mode=['syn','ant','mix'][Number(iso.replace(/-/g,''))%3]; $('#mode').value=STATE.mode; $('#difficulty').value=(Number(iso.replace(/-/g,''))%2)?'easy':'hard'; start(); setMsg('Sfida giornaliera '+iso); });
  $('#helpBtn').addEventListener('click', ()=> alert('Facile/Media: scelta multipla. Difficile: scrittura libera (accenti/plurali/±1).'));
  $('#shareBtn').addEventListener('click', async ()=>{ const grid=STATE.last.join(''); const txt=`S&C ${new Date().toISOString().slice(0,10)}\n${grid}\nScore ${STATE.score} | Combo ${STATE.combo} | Q:${STATE.qcount}`; try{ await navigator.clipboard.writeText(txt); setMsg('Copiato negli appunti.','ok'); }catch(e){ setMsg('Copia non riuscita.','err'); } });
  $('#freeOK').addEventListener('click',()=>{ const v=el.freeInput.value; if(!v) return; check(v,null); el.freeInput.value=''; el.freeInput.focus(); });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && STATE.started && STATE.diff==='hard'){ $('#freeOK').click(); } });
  $('#packSel').addEventListener('change', async ()=>{ const val=$('#packSel').value; const res=await fetch('./packs/'+val+'.json'); DATA=await res.json(); setMsg(val==='it_core'?'Pack IT caricato.':'EN pack loaded.'); });

  // Load default pack
  (async ()=>{ const res=await fetch('./packs/it_core.json'); DATA=await res.json(); })();

  // PWA: register service worker
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }
</script>
</body>
</html>
